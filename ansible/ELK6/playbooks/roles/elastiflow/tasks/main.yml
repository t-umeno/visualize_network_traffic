- name: extract elastiflow
  unarchive:
    src: https://github.com/robcowart/elastiflow/archive/master.zip
    dest: ~/
    remote_src: yes
- name: setup kibana for elastiflow
  command: curl -X POST http://127.0.0.1:5601/api/saved_objects/index-pattern/elastiflow-* -H "Content-Type: application/json" -H "kbn-xsrf: true" -d @elastiflow-master/kibana/elastiflow.index_pattern.json
- name: copy logstash configuration file
  copy:
    src: ~/elastiflow-master/logstash/elastiflow/
    dest: /etc/logstash/elastiflow/
    mode: preserve
    remote_src: yes
    directory_mode: yes
  become: yes
- name: copy logstash service file
  copy:
    src: ~/elastiflow-master/logstash/logstash.service.d/
    dest: /etc/systemd/system/logstash.service.d/
    mode: preserve
    remote_src: yes
    directory_mode: yes
  become: yes
- name: edit pipeline.id in /etc/logstash/pipelines.yml
  blockinfile:
    dest: /etc/logstash/pipelines.yml
    insertafter: EOF
    block: |
      - pipeline.id: elastiflow
      path.config: "/etc/logstash/elastiflow/conf.d/*.conf"
  become: yes
- name: exec /usr/share/logstash/bin/system-install
  command: /usr/share/logstash/bin/system-install
  become: yes
  notify: restart logstash for elastiflow
